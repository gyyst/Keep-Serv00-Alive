name: SSH Server Check

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  ssh-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests paramiko

      - name: Run SSH check
        env:
          SERVER_JSON_URL: ${{ secrets.SERVER_JSON_URL }}  # å­˜å‚¨æœåŠ¡å™¨ä¿¡æ¯JSONçš„URL
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}  # SSHç§é’¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
        run: |
          python - <<EOF
          import os
          import json
          import requests
          import paramiko
          import time
          from datetime import datetime

          # è·å–å½“å‰æ—¶é—´
          current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
          print(f"å¼€å§‹æ£€æŸ¥æœåŠ¡å™¨ - {current_time}")

          # ä»URLè·å–æœåŠ¡å™¨ä¿¡æ¯
          def fetch_servers_from_url():
              server_url = os.getenv('SERVER_JSON_URL')
              if not server_url:
                  raise ValueError("âŒ SERVER_JSON_URL ç¯å¢ƒå˜é‡æœªè®¾ç½®")

              try:
                  # æ·»åŠ è¯·æ±‚å¤´é¿å…è¢«æ‹¦æˆª
                  headers = {
                      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                      'Accept': 'application/json'
                  }
                  
                  # æ·»åŠ è¶…æ—¶å’ŒSSLéªŒè¯
                  response = requests.get(
                      server_url,
                      headers=headers,
                      timeout=10,
                      verify=True
                  )
                  response.raise_for_status()
                  
                  # éªŒè¯JSONç»“æ„
                  data = response.json()
                  if 'servers' not in data:
                      raise ValueError("âš ï¸ æ— æ•ˆçš„JSONç»“æ„: ç¼ºå°‘serverså­—æ®µ")
                  
                  return data['servers']
              
              except requests.exceptions.RequestException as e:
                  raise Exception(f"ğŸ”— ç½‘ç»œè¯·æ±‚å¤±è´¥: {str(e)}")
              except json.JSONDecodeError:
                  raise Exception("ğŸ“„ å“åº”å†…å®¹ä¸æ˜¯æœ‰æ•ˆJSON")

          # æ£€æŸ¥SSHè¿æ¥
          def check_ssh_connection(server):
              result = {
                  "host": server["host"],
                  "port": server.get("port", 22),
                  "username": server["username"],
                  "status": "failed",
                  "message": "",
                  "timestamp": current_time
              }
              
              try:
                  # åˆ›å»ºSSHå®¢æˆ·ç«¯
                  ssh = paramiko.SSHClient()
                  ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                  
                  # è¿æ¥æ–¹å¼ï¼šå¯†ç æˆ–å¯†é’¥
                  connect_kwargs = {
                      "hostname": server["host"],
                      "port": server.get("port", 22),
                      "username": server["username"],
                      "timeout": 10
                  }
                  
                  # æ ¹æ®æä¾›çš„è®¤è¯æ–¹å¼é€‰æ‹©
                  if "password" in server:
                      connect_kwargs["password"] = server["password"]
                  elif "key" in server:
                      # ä½¿ç”¨æä¾›çš„å¯†é’¥
                      key_file = paramiko.RSAKey.from_private_key(file_obj=server["key"])
                      connect_kwargs["pkey"] = key_file
                  elif os.getenv('SSH_KEY'):
                      # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„å¯†é’¥
                      key_data = os.getenv('SSH_KEY')
                      key_file = paramiko.RSAKey.from_private_key(file_obj=key_data)
                      connect_kwargs["pkey"] = key_file
                  
                  # è¿æ¥æœåŠ¡å™¨
                  print(f"æ­£åœ¨è¿æ¥åˆ° {server['host']}:{connect_kwargs['port']} ä½¿ç”¨ç”¨æˆ·å {server['username']}")
                  start_time = time.time()
                  ssh.connect(**connect_kwargs)
                  
                  # æ‰§è¡Œç®€å•å‘½ä»¤
                  stdin, stdout, stderr = ssh.exec_command("echo 'SSHè¿æ¥æˆåŠŸ'")
                  output = stdout.read().decode('utf-8').strip()
                  
                  # å…³é—­è¿æ¥
                  ssh.close()
                  
                  # è®¡ç®—è¿æ¥æ—¶é—´
                  connection_time = time.time() - start_time
                  
                  result["status"] = "success"
                  result["message"] = f"è¿æ¥æˆåŠŸï¼Œè€—æ—¶: {connection_time:.2f}ç§’"
                  print(f"âœ… {server['host']} è¿æ¥æˆåŠŸï¼Œè€—æ—¶: {connection_time:.2f}ç§’")
                  
              except Exception as e:
                  result["message"] = f"è¿æ¥å¤±è´¥: {str(e)}"
                  print(f"âŒ {server['host']} è¿æ¥å¤±è´¥: {str(e)}")
              
              return result

          # ä¸»å‡½æ•°
          def main():
              try:
                  # è·å–æœåŠ¡å™¨åˆ—è¡¨
                  servers = fetch_servers_from_url()
                  print(f"è·å–åˆ° {len(servers)} ä¸ªæœåŠ¡å™¨ä¿¡æ¯")
                  
                  # æ£€æŸ¥æ¯ä¸ªæœåŠ¡å™¨
                  results = []
                  for server in servers:
                      # æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è¿‡è¯¥æœåŠ¡å™¨
                      if server.get("skip", False):
                          print(f"â­ï¸ è·³è¿‡æœåŠ¡å™¨ {server['host']} (å·²è®¾ç½®ä¸ºskip)") 
                          result = {
                              "host": server["host"],
                              "port": server.get("port", 22),
                              "username": server["username"],
                              "status": "skipped",
                              "message": "æœåŠ¡å™¨å·²è®¾ç½®ä¸ºè·³è¿‡æ£€æŸ¥",
                              "timestamp": current_time
                          }
                          results.append(result)
                          continue
                          
                      result = check_ssh_connection(server)
                      results.append(result)
                  
                  # è¾“å‡ºç»“æœæ‘˜è¦
                  success_count = sum(1 for r in results if r["status"] == "success")
                  skipped_count = sum(1 for r in results if r["status"] == "skipped")
                  checked_count = len(results) - skipped_count
                  print(f"\næ£€æŸ¥å®Œæˆ: {success_count}/{checked_count} ä¸ªæœåŠ¡å™¨è¿æ¥æˆåŠŸ, {skipped_count} ä¸ªæœåŠ¡å™¨è¢«è·³è¿‡")
                  
                  # ä¿å­˜ç»“æœåˆ°æ–‡ä»¶
                  with open('ssh_check_results.json', 'w') as f:
                      json.dump(results, f, indent=2, ensure_ascii=False)
                  
                  print("ç»“æœå·²ä¿å­˜åˆ° ssh_check_results.json")
                  
              except Exception as e:
                  print(f"æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºé”™: {str(e)}")
                  exit(1)

          if __name__ == "__main__":
              main()
          EOF
